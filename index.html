<html>
  <head>
    <title>Laughing all the Time</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <link href=' http://fonts.googleapis.com/css?family=Droid+Sans' rel='stylesheet' type='text/css'>
    <link href="loadingbar.css" rel="stylesheet" />
    <style>
      a:link {
          color: #36C4D8;
          background-color: transparent;
          text-decoration: none;
      }

      a:hover {
          color: #F3D847;
          background-color: transparent;

      }
      a:active {
          color: #B16FAD;
          background-color: transparent;

      }
</style>
  </head>
  <body>
  <div id = "curtain" >
        
          <div id= "start">
            
            <a onclick="begin()"> 
              Lazy Heart<br/><br/>
              
              <img src = images/Vintage-GraphicsFairy1.png> <br/><br/>

              Laughing all the Time <br/>
              
            </a>
          </div>

          <div id = "ending" >

            <p>
            <a href = http://www.lazyheart.net target = "_blank">Song by Lazy Heart<br/><br/></a>
            <a href = http://www.8ude.com target = "_blank">Animations by Corey B<br/></a>
            </p>
       
          </div>
       
  </div>
  <div id = "bottomLinks">

      <a href = http://www.lazyheart.net target = "_blank">Song by Lazy Heart<br/></a>

      <a href = http://www.8ude.com target = "_blank">Animations by Corey B</a>

  </div>
  

   
    <script src="lib/three.js"></script>

    <script src="lib/AudioController.js"></script>
    <script src="lib/Stream.js"></script>
    <script src="lib/AudioTexture.js"></script>

    <script src="lib/FirstPersonControls.js"></script>
    <script src="lib/TweenLite.min.js"></script>
    
    <script src="lib/HeartSprite.js"></script>
    <script src="lib/jquery.min.js"></script>

<!--shaders go here until i find a way to load them seperately that doesn't suck ass -->
    <script type="x-shader/x-vertex" id="vertexShader">  
      varying vec3 vNormal;
      varying vec3 vViewPosition;

      void main() {

        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        vNormal = normalize( normalMatrix * normal );
        vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
        vViewPosition = -mvPosition.xyz;

      }
    </script>

    <script type="x-shader/x-fragment" id="fragmentShader">  
      uniform vec3 uMaterialColor;

      uniform vec3 uDirLightPos;
      uniform vec3 uDirLightColor;

      uniform float uKd;
      uniform float uBorder;


      varying vec3 vNormal;
      varying vec3 vViewPosition;

      void main() {
        // compute direction to light
        vec4 lDirection = viewMatrix * vec4( uDirLightPos, 0.0 );
        vec3 lVector = normalize( lDirection.xyz );

        // diffuse: N * L. Normal must be normalized, since it's interpolated.
        vec3 normal = normalize( vNormal );
        

        float diffuse = max( dot( normal, lVector ), 0.0);
        if (diffuse > uBorder) {
            diffuse = 1.0;
        } else if (diffuse > (uBorder / 4.0)) {
            diffuse = 0.8;
        } else diffuse = 0.6;

        gl_FragColor = vec4( uKd * uMaterialColor * uDirLightColor * diffuse, 1.0 );
      }
    </script>

    <script>



      //COLOR PALETTE:
      //LIGHT BLUE: 54,196,216 #36C4D8
      //RED: 214,51,52 #D63334
      //YELLOW: 243,215,71 #F3D847
      //LAVENDER: 177,111,173 #B16FAD
      //

      // General three.js variables
      var camera, controls, scene, renderer, projector;

      // If using post-processor - send scene to EffectComposer
      var composer;
      var cameraDummy;

      /////////////////////////////////
      /////////////////////////////////
      /////////////TIMES///////////////
      /////////////////////////////////
      /////////////////////////////////

  
      var clock = new THREE.Clock();
      var time, delta;

      var scene1bstart = 70.0;
      var scene2start = 100.0;
      var scene2bstart = 140.0;
      var scene3start = 173.0;
      var scene3bstart = 186.0;
      var scene4start = 218.0;
      var scene5start = 253.0;
      var endFade = 340.0;
      var endingTime = 350.0;

      renderer = new THREE.WebGLRenderer();
      renderer.setSize( window.innerWidth, window.innerHeight );
      document.body.appendChild( renderer.domElement );
      renderer.setClearColor( 0xaaccff );


      window.addEventListener( 'resize', onWindowResize, false );
      document.addEventListener( 'mousemove', onDocumentMouseMove, false );
      document.addEventListener( 'mousedown', onDocumentMouseDown, false);
      document.addEventListener( 'mouseup', onDocumentMouseUp, false);

      
      //               \\
      // SCENE OBJECTS \\
      //               \\ 
      var floor, floorGeometry, ceiling, ceilingGeometry, ceilingMaterial, floorTexture, 
      sunMesh, sunGeometry, sunTexture, sunChanging, sunPivot,
      landscapeChanging, floorPivot,
      coronaMesh, coronaGeometry, outerCorona, thirdCorona;

      var lazyLightBlue = new THREE.Color(0x36c4d8);
      var lazyRed = new THREE.Color(0xd63334);
      var lazyYellow = new THREE.Color(0xf3d847);
      var lazyLavender = new THREE.Color(0xb16fad);
      var origFogColor = new THREE.Color(0xaaccff);

      var coronaVertPos = [];

      //var spriteA;
      //var numSprites = 20;

      var floorSmoothing = 0.1;
      var ceilingSmoothing = 0.1;

      ////////////////////////
      //using these vars in //
      //tweens, not the best//
      //but w/e///////////////
      ////////////////////////


      var backgroundChange = {amt: 0.0};
      var fogChange = {amt: 0.0};
      var spriteOpacity = {value:1.0};

      // Ground Geo Vars
      var worldWidth = 32, worldDepth = 32,
      worldHalfWidth = worldWidth/2, worldHalfDepth = worldDepth/2;
      

      //Audio Vars
      var audioController = new AudioController();
      var stream = new Stream('Lazy.mp3', audioController );
 

      var light, light2;

      //Raycaster
      var raycaster, mouse, INTERSECTED, SELECTED;
      //var sceneSprites = [];
      //var spriteArray = [];


      init();
      animate();
      function init() {
        // Scene
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2( 0xaaccff, 0.1 );

        // Camera
        camera = new THREE.PerspectiveCamera(120, window.innerWidth / window.innerHeight, 1, 10000 );
        camera.up.set(0,1,0);
        camera.position.y = 600;

        scene.add( camera );
        

        // Controls
        controls = new THREE.FirstPersonControls(camera);
        controls.movementSpeed = 1;
        controls.lookSpeed = 0.1;
        controls.enabled = false;

        // Raycaster and Mouse
        raycaster = new THREE.Raycaster();
        mouse = new THREE.Vector2();

       

        //lights
        light = new THREE.PointLight( 0xffffff);
        light.position.set( 0,20,20 );

        light2 = new THREE.PointLight( 0xff00ff );
        light2.position.set( 0, 200, 50 );

        scene.add(light);
        scene.add(light2);


        // Scene Oobjects
        floorMaterial = new THREE.MeshPhongMaterial( {shading : THREE.FlatShading} );
        floorGeometry = new THREE.PlaneGeometry(10000, 10000, worldWidth, worldDepth);
        floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.position.y -= 1800;
        floor.rotateOnAxis(new THREE.Vector3(1,0,0), - Math.PI / 2 );

        floorPivot = new THREE.Object3D();
        floorPivot.position.y = camera.position.y;
        floorPivot.add(floor);
        scene.add(floorPivot);

        ceilingMaterial = new THREE.MeshPhongMaterial( {wireframe: true, wireframeLinewidth: 2.0} );
        ceilingGeometry = new THREE.PlaneGeometry(10000, 10000, worldWidth, worldDepth);
        ceiling = new THREE.Mesh(ceilingGeometry, ceilingMaterial);
        ceiling.material.transparent = true;
        ceiling.material.opacity = 0.0;
        ceiling.position.y += 500;
        ceiling.rotateOnAxis(new THREE.Vector3(1,0,0), Math.PI / 2 );

        floorPivot.add(ceiling);
        

        coronaGeometry = new THREE.IcosahedronGeometry(200, 1);
        coronaMaterial = new THREE.MeshPhongMaterial ({
          color: 0xF3D847,
          emissive: 0xffde00,
          specular: 0xffffff,
          wireframe: true,
        });
        coronaMesh = new THREE.Mesh( coronaGeometry, coronaMaterial);
        coronaMesh.material.transparent = true;
        coronaMesh.material.opacity = 0.01;

        /*
        sceneSprites = [];
        for (var i = 0; i < numSprites; i++) {

          
          var position = new THREE.Vector3();
          position.x = (camera.position.x + Math.random()*100 - 50);
          position.y = (camera.position.y + Math.random()*50 - 15);
          position.z = (camera.position.z - Math.random()*30 + 10);

          var type = Math.floor(Math.random()*3);

          var superSprite = new HeartSprite(position, type);
          var affectSun = Math.round(Math.random()) == 1 ? true : false;
          var affectLandscape = Math.round(Math.random()) == 1 ? true : false;
          superSprite.changeSun = affectSun;
          if (affectSun == false) {
            superSprite.changeLandscape = true;
          }

          sceneSprites[i] = superSprite;

          superSprite.init();
          spriteArray[i] = superSprite.sprite;


          scene.add(superSprite.sprite);


        }
        */

        // Here comes the sun little darling //
        sunChanging = false;
        sunGeometry = new THREE.IcosahedronGeometry(100, 1);

        var materialColor = new THREE.Color();
        materialColor.setRGB(1.0, 0.8, 0.6);

        //shader properties
        var uniforms = {

          uDirLightPos: { type: "v3", value: new THREE.Vector3() },
          uDirLightColor: { type: "c", value: new THREE.Color( 0xFFFFFF ) },

          uMaterialColor: { type: "c", value: materialColor },

          uKd: {
            type: "f",
            value: 0.9
          },
          uBorder: {
            type: "f",
            value: 0.2
          }


        }

        sunMaterial = new THREE.ShaderMaterial ({
          uniforms: uniforms,
          vertexShader: document.getElementById('vertexShader').textContent,
          fragmentShader: document.getElementById('fragmentShader').textContent
        });

        sunMaterial.uniforms.uMaterialColor.value.copy(materialColor);
        sunMaterial.side = THREE.DoubleSide;
        sunMaterial.uniforms.uDirLightPos.value = light.position;
        sunMaterial.uniforms.uDirLightColor.value = light.color;
        
        sunMesh = new THREE.Mesh( sunGeometry, sunMaterial);
        sunMesh.add(coronaMesh);


        sunMesh.position.set(0, camera.position.y + 500, camera.position.z - 1000);
        sunPivot = new THREE.Object3D();
        sunPivot.position = camera.position;

        scene.add(sunMesh);
        scene.add(sunPivot);
        sunPivot.add(sunMesh);

        }
      

      function animate() {
 
        delta = clock.getDelta();
        time += delta;

        controls.update(delta);
        
        /*
        for (var i = 0; i < numSprites; i ++) {
          sceneSprites[i].update(delta);
        }
        */

       

        coronaMesh.rotation.z += 0.02;

        sunMesh.rotation.z -= 0.01;

        // FOG Fade OUT; Corona Fade In //
        TweenLite.to(scene.fog, 15, {density: 0.0007});
        TweenLite.to(coronaMesh.material, 15, {opacity: 0.3})


        /// A u d i o R e a c t i v i t y ///

        audioController.update();

        SunExpand();

        for (var i = 0; i < audioController.analyzer.array.length; i++) {
          floorGeometry.vertices[i].z += (audioController.analyzer.array[i]*10-floorGeometry.vertices[i].z)*floorSmoothing;
          ceilingGeometry.vertices[i].z -= (audioController.analyzer.array[i]*20+ceilingGeometry.vertices[i].z)*(floorSmoothing/4);
        }

        floor.geometry.verticesNeedUpdate = true;
        ceiling.geometry.verticesNeedUpdate = true;

        // sun sun sun changing //
        if (sunChanging) {
          changeSunColor();
          sunChanging = false;
        } else if (landscapeChanging) {
          shiftLandscape();
          landscapeChanging = false;
        }

        ////////////////// \\\\\\\\\\\\\\\\\\\\\
        //    change light position           \\
        //    based on mouse position         \\
        //\\\\\\\\\\\\\\\\ ///////////////////\\ 
        light.position.x = mouse.x * 200;
        light.position.y = mouse.y * 200;
        sunMaterial.uniforms.uDirLightPos.value.x = light.position.x;
        sunMaterial.uniforms.uDirLightPos.value.y = light.position.y;


        ///////////////////////////
        ///////////////////////////
        ///////Scene Changes///////
        ///////////////////////////
        ///////////////////////////

        if (time > scene1bstart && time < scene2start) {
          scene1b();
        }
        if (time > scene2start && time < scene2bstart) {
          scene2();
        }
        else if (time > scene2bstart && time < scene3start) {
          scene2b();
        }
        else if (time > scene3start && time < scene3bstart) {
          scene3();
        }
        else if (time > scene3bstart && time < scene4start) {
          scene3b();
        }
        else if (time > scene4start && time < scene5start) {
          scene4();
        }
        else if (time > scene5start && time < endFade) {
          scene5();
        }
        else if (time > endFade && time < songEnd) {
          sceneFade();
        }
        else if (time > endingTime) {
          songEnd();
        }


        requestAnimationFrame( animate );
        render();

      }

      function render () {


      /*
        raycaster.setFromCamera( mouse, camera );
        var intersects = raycaster.intersectObjects( spriteArray );
        if ( intersects.length > 0 ) {
          if ( INTERSECTED != intersects[ 0 ].object.myParent && SELECTED == null) {
            INTERSECTED = intersects[ 0 ].object.myParent;
            INTERSECTED.HOVER = true;

          }
        } else {
          if (INTERSECTED != null) { INTERSECTED.HOVER = false }

          INTERSECTED = null;
        }
      */
        
        renderer.render(scene, camera); 


      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        renderer.setSize( window.innerWidth, window.innerHeight );


      }

      function onDocumentMouseMove( event ) {
        event.preventDefault();
        mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
        mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

      }

      function onDocumentMouseDown(event) {

        event.preventDefault();
        /*
        raycaster.setFromCamera( mouse, camera );
        var intersects = raycaster.intersectObjects( spriteArray );
        if ( intersects.length > 0 ) {

          SELECTED = intersects[ 0 ].object.myParent;
          if (SELECTED.cooldownTimer <= 0.0 ) { 
            SELECTED.CLICKED = true;
            SELECTED.HOVER = false;
            if (SELECTED.changeSun) {
              sunChanging = true;
            } else if (SELECTED.changeLandscape) {
              landscapeChanging = true;
            }
          }
        }
        */
      }

      function onDocumentMouseUp(event) {
        SELECTED.CLICKED = false;
        SELECTED = null;
      }

      function SunExpand() {

        for (var i = 0; i < coronaGeometry.vertices.length; i++) {
          

          var currentPos = new THREE.Vector3(coronaGeometry.vertices[i].x, coronaGeometry.vertices[i].y, coronaGeometry.vertices[i].z);

          var meshPosition = new THREE.Vector3();
          meshPosition.copy(coronaMesh.position);

         
          var destVector = new THREE.Vector3();
          destVector.subVectors(currentPos, meshPosition);
          destVector.normalize();

          var audioExpansion = i % 2 == 0 ? audioController.analyzer.array[10] * 2 : audioController.analyzer.array[25] * 2;

          destVector.multiplyScalar(audioExpansion);

          if (audioExpansion > 0) {
            destVector.x -= currentPos.x;
            destVector.y -= currentPos.y;
            destVector.z -= currentPos.z;
          }

          destVector.multiplyScalar(0.1);

          coronaGeometry.vertices[i].add(destVector);
        }

        coronaMesh.geometry.verticesNeedUpdate = true;

        for (var i = 0; i < sunGeometry.vertices.length; i++) {
          

          var currentPos = new THREE.Vector3(sunGeometry.vertices[i].x, sunGeometry.vertices[i].y, sunGeometry.vertices[i].z);
     
          var meshPosition = new THREE.Vector3();
          meshPosition.set(0,0,0);
  
         
          var destVector = new THREE.Vector3();
          destVector.subVectors(currentPos, meshPosition);
          destVector.normalize();

          var audioExpansion = i % 2 == 0 ? audioController.analyzer.array[15] : audioController.analyzer.array[45] ;
  
          destVector.multiplyScalar(audioExpansion);



          if (audioExpansion > 0) {
            destVector.x -= currentPos.x;
            destVector.y -= currentPos.y;
            destVector.z -= currentPos.z;
          }

          destVector.multiplyScalar(0.1);
       

          sunGeometry.vertices[i].add(destVector);
        }

        sunMesh.geometry.verticesNeedUpdate = true;

      }

      function changeSunColor() {
        
        var materialR = 0.75 + (Math.random()/4);
        var materialG = 0.75 + (Math.random()/4);
        var materialB = 0.5 + (Math.random()/2);

        var newUBorder = Math.random();
        var newLineWeight = Math.random() * 10.0;
        
        TweenLite.to(sunMaterial.uniforms.uMaterialColor.value, 3.0, {r: materialR, g: materialG, b: materialB });
        TweenLite.to(sunMaterial.uniforms.uBorder, 3.0, {value: newUBorder} );
        TweenLite.to(coronaMaterial.emissive, 3.0, {r: materialR, g: materialG, b: materialB });
        TweenLite.to(coronaMaterial, 3.0, { wireframeLinewidth: newLineWeight });

      }

      function shiftLandscape () {
        console.log("changing landscape");
        var newAngle = Math.PI * Math.random()/2
        var newRot = floorPivot.rotation.x + newAngle;
        var newSun = Math.sin(newAngle) * 600 + 200; 
        TweenLite.to(floorPivot.rotation, 4.0, {x: newRot});
        TweenLite.to(sunPivot.rotation, 4.0, {z: newRot});

      }

      function begin() {
          var curtain = $("#curtain");
            if(curtain.css("display") == "block"){
              curtain.fadeOut('slow',function(){
               
               $("#start").css("display","none"); 
               $("#splashText").css("display","none"); 
                
              })    
            }
          time = 0;
          controls.enabled = true;
          
          stream.play();
      }

      function songEnd() {
        $("#curtain").css("background","#000");
        $("#curtain").css( "opacity", "0.8");
            $("#curtain").fadeIn(5000 , function(){
              
              $("#ending").css("display", "block");
              $("#bottomLinks").fadeOut();
            });


        controls.enabled = false

      }

      function scene1b() {

      var sceneTime = time - scene1bstart;
      var sceneDuration = scene2start - scene1bstart;
      var frequency = 2 * Math.PI / sceneDuration;

      light2.color.g += 0.5 * Math.sin(frequency * time) * delta;
      light2.color.r -= 0.5 * Math.sin(frequency * time) * delta;



      }

      function scene2() {
        
        TweenLite.to(backgroundChange, 20, {amt:1.0, ease:Power0.easeNone});

        var currentColor = new THREE.Color(0xaaccff);
        var destColor = lazyRed;
        currentColor.lerp(destColor, backgroundChange.amt);
        scene.fog.color = currentColor;
        TweenLite.to(light2.color, 10, {g:1.0});
        
        renderer.setClearColor(currentColor.getHex());

        TweenLite.to(ceiling.material, 20.0, {opacity: 0.3});

        TweenLite.to(coronaMesh.material, 10, {opacity:0.0});

        TweenLite.to(controls, 10, {lookSpeed: 0.01});

      }

      function scene2b() {

        ceilingSmoothing += delta;
        TweenLite.to(ceilingMaterial, 10, {wireframeLinewidth: 10});
        TweenLite.to(controls, 20, {lookSpeed: 0.2});


      }

      function scene3() {

        
        coronaMaterial.wireframe = false;
        TweenLite.to(controls, 20, {lookSpeed: 0.1});

        TweenLite.to(coronaMesh.material, 10, {opacity:0.4});
        TweenLite.to(ceiling.material, 10, {opacity:0.0});
        TweenLite.to(ceilingMaterial, 10, {wireframeLinewidth:0});

        TweenLite.to(backgroundChange, 10.0, {amt:0.0, ease:Power0.easeNone});

        var currentColor = lazyRed;
        var destColor = origFogColor;
        currentColor.lerp(destColor, (1.0 - backgroundChange.amt));
        scene.fog.color = currentColor;
        TweenLite.to(light2.color, 10, {g:0.0});
        
        renderer.setClearColor(currentColor.getHex());

        TweenLite.to(ceiling.material, 20.0, {opacity: 0.1});

        
      }

      function scene3b() {

          ceilingSmoothing = 0.1;
          ceilingMaterial.wireframe = false;
          TweenLite.to(ceiling.material, 10, {opacity: 0.4});

          var sceneTime = time - scene3bstart;
          var sceneDuration = scene4start - scene3bstart;
          var frequency = 2 * Math.PI / sceneDuration;
          light2.color.g += 0.5 * Math.sin(frequency * time) * delta;
          light2.color.b -= 0.5 * Math.sin(frequency * time) * delta;

      }

      function scene4() {

        TweenLite.to(backgroundChange, 20, {amt:1.0, ease: Linear.easeNone});
        TweenLite.to(controls, 10, {lookSpeed: 0.04});

        var currentColor = origFogColor;
        var destColor = lazyYellow;
        currentColor.lerp(destColor, (backgroundChange.amt));
        scene.fog.color = currentColor;
          
        renderer.setClearColor(currentColor.getHex());

        TweenLite.to(ceilingMaterial, 20.0, {wireframeLinewidth: 3.0});
        TweenLite.to(ceiling.position, 20.0, {y: 200});
        TweenLite.to(light2.color, 5.0 , {r:1.0, g:0.0, b:1.0});
        TweenLite.to(light.color, 20.0, {r:lazyLavender.r, g: lazyLavender.g, b:lazyLavender.b});

      }

      function scene5() {
      
        TweenLite.to(controls, 10, {lookSpeed: 0.01});
        var currentColor = lazyYellow;
        var destColor = new THREE.Color(0.1, 0.0, 0.5);

        TweenLite.to(currentColor, 40, {r:0.1, g:0.0, b:0.5});
 
        scene.fog.color = currentColor;
          
        renderer.setClearColor(currentColor.getHex());

        if (time > scene5start + 30) {
          TweenLite.to(light, 20, {intensity: 0.3});
          TweenLite.to(light2, 20, {intensity: 0.3});

        }

        TweenLite.to(ceiling.position, 20.0, {y: 400});
        TweenLite.to(ceiling.scale, 40, {x: 5.0, y:5.0});

        /*
        TweenLite.to(spriteOpacity, 60,{value: 0.1, ease:Linear.easeNone});

        for (var i = 0; i < numSprites; i ++) {

          sceneSprites[i].resetOpacity = spriteOpacity.value;
        
        }
        */

      }
      function sceneFade() {

      TweenLite.to(currentColor, 10, {r:0.0, g:0.0, b:0.0});

      scene.fog.color = currentColor;
        
      renderer.setClearColor(currentColor.getHex());

      TweenLite.to(scene.fog, 10.0, {density: 1.0});

      }
      
    </script>
      
  </body>
</html>
